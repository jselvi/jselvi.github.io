---
layout: post
title: From Case-Insensitive to RCE
date: '2015-02-20T10:30:00.000+01:00'
author: Jose Selvi
tags:
- WebSecurity
modified_time: '2015-02-20T10:30:00.366+01:00'
thumbnail: http://3.bp.blogspot.com/-Zxh1YsIX6X8/VObkt_5TY1I/AAAAAAAAB38/eJ5Au7TF184/s72-c/sourcecode.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-1151898778032183065
blogger_orig_url: http://www.en.pentester.es/2015/02/from-case-insensitive-to-rce.html
---

<div style="text-align: justify;">This post was written by <b>The DarkRaver</b>. He's a close friend and one of the best skilled security professionals that I have ever met. He's also known by publishing tools such as dirb or sqlibf that I strongly recommend.<br /><br />Go ahead with his post:</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">------------------------------------------------------</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Some time ago, I was doing a webapp penetration testing when I found something really interesting. The application was coded in PHP and it relied on some commercial components. Soon I found lots of XSS and SQLi vulnerable forms, but we won't focus on that in this post.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Suddenly, I realised that requesting the same page in uppercase or lowercase changed its behavior. The webserver was based on Apache and Linux (case sensitive) but the files seem to be hosted in a cases insensitive filesystem (maybe a NAS share?), so when I requested page.php it responded as expected, but when I requested page.PHP its source code was shown.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-Zxh1YsIX6X8/VObkt_5TY1I/AAAAAAAAB38/eJ5Au7TF184/s1600/sourcecode.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-Zxh1YsIX6X8/VObkt_5TY1I/AAAAAAAAB38/eJ5Au7TF184/s1600/sourcecode.png" height="259" width="640" /></a></div><br /><div style="text-align: justify;">That vulnerability allowed to review the commercial application's source code, where I found several potentially dangerous functions such as "include()" and "include_once()" that could be vulnerable. No other dangerous functions such as "system()", "open()" or "file_get_contents()" were found.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">A few minutes later I could confirm that at least one of those "include_once()" functions was vulnerable to LFI and exploitable. However, only files with .js extension could be loaded.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-A9_j9SuQ_tQ/VObmDYge2CI/AAAAAAAAB4I/fjV1AxkRKMw/s1600/vuln.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-A9_j9SuQ_tQ/VObmDYge2CI/AAAAAAAAB4I/fjV1AxkRKMw/s1600/vuln.png" height="164" width="640" /></a></div><br /><div style="text-align: justify;">I tried several ways to bypass this protection, such as null byte, long paths, etc, but nothing seemed to work. So... we're tied to that. How we could upload or create a .js file in the local filesystem?</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The upload forms didn't allow that kind of extensions and we weren't able to create files inside the server. Or... maybe we were? What about the following piece of code?</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-7ACVdyBid98/VObn2C-AfbI/AAAAAAAAB4U/0f8Y_5rmRuA/s1600/pieceofcode.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-7ACVdyBid98/VObn2C-AfbI/AAAAAAAAB4U/0f8Y_5rmRuA/s1600/pieceofcode.png" height="158" width="640" /></a></div><br /><div style="text-align: justify;">It was a feature that allowed to cache JavaScript files on disk! But... How could we inject custom content in those cached files?</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">An in-depth look showed that some JavaScripts were generated from a template and one of them included some user controled parameters. That sounds great!</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-znUwWd0Dvc0/VObpHDHvFGI/AAAAAAAAB4g/Gox9PnenyHo/s1600/patterns.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-znUwWd0Dvc0/VObpHDHvFGI/AAAAAAAAB4g/Gox9PnenyHo/s1600/patterns.png" height="148" width="640" /></a></div><br /><div style="text-align: justify;">Even better, the injectable parameter was the same that was vulnerable to LFI, so we could find a way to exploit both vulnerabilities at the same time.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">JavaScript files were stored in a path like that: "/cache/".<b>$offv</b>.$theme.$lang.$type.$name.".js" , where $offv was the user provided input and the other parts could be easy guessed looking at the source code. So... the exploit string should be as follows:</div><br /><div style="text-align: center;"><b>http://www.app.com/plugin/minjs.php?</b></div><div style="text-align: center;"><b>offending_var=../../cache/&lt;?phpinfo();?&gt;defaultes-lacoredefault</b></div><br />However, I got a "500 - Internal Server Error". What the hell??? Something was terribly crashing. How we could fix it? I tried some other PHP functions such as "system()", "file_get_contents()" and "phpversion()" but most of them crashed in the same way.<br /><br />Wait, what if the exploit works but it crashes at some point after that? what if we try to "exit()" the execution?<br /><br /><div style="text-align: center;"><b><span style="font-size: large;">http://www.app.com/plugin/minjs.php?</span></b></div><div style="text-align: center;"><b><span style="font-size: large;">offending_var=../../cache/&lt;?system(“id”);exit();?&gt;defaultes-lacoredefault</span></b></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-UMTDrLoxevo/VObtw2lLb4I/AAAAAAAAB4s/q1v8LK3xhBg/s1600/pwned.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-UMTDrLoxevo/VObtw2lLb4I/AAAAAAAAB4s/q1v8LK3xhBg/s1600/pwned.png" height="296" width="640" /></a></div><br /><div style="text-align: justify;">It works! Finally I had Remote Code Execution in the server, and everything began with a small source code leak caused by a case-insensitive filesystem. Small things sometimes cause big troubles.</div>