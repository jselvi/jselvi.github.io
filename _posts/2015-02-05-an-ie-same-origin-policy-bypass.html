---
layout: post
title: An IE Same Origin Policy Bypass story
date: '2015-02-05T16:55:00.002+01:00'
author: Jose Selvi
tags:
- WebSecurity
- BrowserSecurity
modified_time: '2015-02-05T16:55:45.112+01:00'
thumbnail: http://4.bp.blogspot.com/-xHxcxw5KF30/VNOCf48h4sI/AAAAAAAAB2k/S3-a9a4d4NI/s72-c/Exploit.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-5066343484193660313
blogger_orig_url: http://www.en.pentester.es/2015/02/an-ie-same-origin-policy-bypass.html
---

<div style="text-align: justify;">A couple of days ago I was reading my feeds when suddenly a headline caught my attention: "<b>Serious bug in fully patched Internet Explorer put user credentials at risk</b>". A same-origin-policy bypass in Internet Explorer had been released. This is a really critical vulnerability, because SOP provides isolation between different websites inside our browser, and avoid evil sites to get access to other sites and modify its content and so on.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">I have been taking a look for the last few hours and it definitely works. The <a href="http://www.deusen.co.uk/items/insider3show.3362009741042107/" target="_blank">provided PoC</a> works but perhaps isn't the most practical approach. As far as I know, details of this vulnerability haven't been published apart from the PoC itself, so let's have a look to the PoC. I have prepared my own PoC, just to see if I could use this vulnerability for more evil purposes.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-xHxcxw5KF30/VNOCf48h4sI/AAAAAAAAB2k/S3-a9a4d4NI/s1600/Exploit.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-xHxcxw5KF30/VNOCf48h4sI/AAAAAAAAB2k/S3-a9a4d4NI/s1600/Exploit.png" height="243" width="640" /></a></div><br /><div style="text-align: justify;">At first sight, the vulnerability seems to be a race condition or similar. There are two iframes, the first one loads a dynamic webpage, for example 1.php. Its source code wasn't published with the PoC but it simply waits for a few seconds and then it redirects to the same url than the second iframe.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Both iframes load a webpage in the target website. It's important to find a webpage that could be loaded inside an iframe because if not the vulnerability isn't exploitable. Providers such as Google, Facebook, etc usually configure their sites with the "<b>X-Frame-Options</b>" header in order to avoid <a href="https://www.owasp.org/index.php/Clickjacking_Defense_Cheat_Sheet" target="_blank">ClickJacking attacks</a>.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-vGz5vEzcIpE/VNOD5y2XfvI/AAAAAAAAB2w/KQhrPUAM5aU/s1600/XFrameOptions.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-vGz5vEzcIpE/VNOD5y2XfvI/AAAAAAAAB2w/KQhrPUAM5aU/s1600/XFrameOptions.png" height="366" width="640" /></a></div><br /><div style="text-align: justify;">However, a single page with no "X-Frame-Options" in the domain is enough for us, and this is not as difficult to find as it seems. There are two well known resources that aren't protected in most websites: robots.txt (the one used by the original author) and <b>favicon.ico</b> (I used that one because it looks better for a practical attack).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">There is a function called "<b>go()</b>" that makes the real exploitation. It's difficult to read so let me decode it for you.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-4TUv_LeJLts/VNOG3Cceb-I/AAAAAAAAB28/fzGyZc0JpCg/s1600/Payload.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-4TUv_LeJLts/VNOG3Cceb-I/AAAAAAAAB28/fzGyZc0JpCg/s1600/Payload.png" height="124" width="640" /></a></div><br /><div style="text-align: justify;">Here is where interesting things happen. There are some "<b>alert</b>" and "<b>eval</b>" calls that seem to be important. I couldn't figure out why, but if you change them it won't work. This is the tricky part in this vulnerability.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">It gets the second iframe that we were talking before and store it in a variable "<b>x</b>". Then it waits a few seconds (1 second in the code) and shows an alert message. As I previously said, that alert seem to be important so we can remove it, but we can use a message that won't warn the user that something bad is just about to happen. After that, when the first iframe has already changed from my evil domain to the target domain (because of 1.php) a piece of javascript and HTML code is injected in that second iframe. We shouldn't be able to to that, because it's a different domain, but we are. <b>The same origin policy has been bypassed</b>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Let's see what a victim would see:</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-_a2j3skcLNY/VNOJ2Y6vkdI/AAAAAAAAB3I/Mvb8V29vwYE/s1600/1popup.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-_a2j3skcLNY/VNOJ2Y6vkdI/AAAAAAAAB3I/Mvb8V29vwYE/s1600/1popup.png" height="424" width="640" /></a></div><br /><div style="text-align: justify;">Some countries have specific laws about cookies and a warning message is needed at most websites, so users are used to click "OK".</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-604tIZWHQZk/VNOKTbfduBI/AAAAAAAAB3Q/Mobu6OwuiMg/s1600/2post.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-604tIZWHQZk/VNOKTbfduBI/AAAAAAAAB3Q/Mobu6OwuiMg/s1600/2post.png" height="424" width="640" /></a></div><br /><div style="text-align: justify;">When I injected the javascript and HTML code in the iframe, I used a Google button. It isn't the most beautiful blog but well... It looks like a real blog :)</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ogfKJ422SLE/VNOKwGIJpTI/AAAAAAAAB3Y/fBXecMBWi5E/s1600/3google.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-ogfKJ422SLE/VNOKwGIJpTI/AAAAAAAAB3Y/fBXecMBWi5E/s1600/3google.png" height="560" width="640" /></a></div><br /><div style="text-align: justify;">The Google authentication page is opened. Everything looks fine but I have changed the form action using the injected javascript code.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-dty6ObyNNNM/VNOLD-Zi4FI/AAAAAAAAB3g/LmC4x8VjAHw/s1600/4grab.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-dty6ObyNNNM/VNOLD-Zi4FI/AAAAAAAAB3g/LmC4x8VjAHw/s1600/4grab.png" height="558" width="640" /></a></div><br /><div style="text-align: justify;">Done! A really cool vulnerability. I can't wait for more details about the vulnerability. Let's see if in a few days we can know why "alert", "eval" and "setTimeout" are sometimes as important as they are.</div>